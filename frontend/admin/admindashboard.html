<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-auth-compat.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        .logout-btn {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }

        .logout-btn:hover {
            background: linear-gradient(90deg, #c0392b, #a52818);
            transform: translateY(-2px);
        }
        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(45deg, #1a2980, #26d0ce);
            color: white;
            padding: 20px;
            animation: slideIn 0.5s ease;
            position: fixed;
            height: 100%;
            z-index: 100;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .sidebar h2 {
            margin-bottom: 30px;
            color: #ecf0f1;
            text-align: center;
            font-size: 28px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 15px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            display: flex;
            align-items: center;
        }

        .sidebar li i {
            margin-right: 10px;
            font-size: 20px;
        }

        .sidebar li:hover, .sidebar li.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(10px);
        }

        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: 280px;
            position: relative;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .stat-card {
            background-image: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: -50%;
            left: -50%;
            background: rgba(255,255,255,0.1);
            transform: rotate(45deg);
            transition: all 0.6s ease;
        }

        .stat-card:hover::before {
            top: -10%;
            left: -10%;
        }

        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 25px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            font-size: 20px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .stat-card p {
            font-size: 32px;
            font-weight: bold;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 30px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: linear-gradient(90deg, #1a2980, #26d0ce);
            color: white;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 14px;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background: #f5f5f5;
            transition: background 0.3s ease;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 28px;
            font-weight: 600;
            position: relative;
            padding-bottom: 10px;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 4px;
            background: linear-gradient(90deg, #1a2980, #26d0ce);
            border-radius: 2px;
        }

        .search-bar {
            width: 100%;
            margin-bottom: 20px;
            display: flex;
        }

        .search-bar input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px 0 0 8px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            border-color: #1a2980;
            box-shadow: 0 0 0 2px rgba(26, 41, 128, 0.1);
        }

        .search-bar button {
            padding: 12px 20px;
            background: linear-gradient(90deg, #1a2980, #26d0ce);
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-bar button:hover {
            background: linear-gradient(90deg, #152169, #1eafad);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: linear-gradient(90deg, #1a2980, #26d0ce);
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .edit-btn {
            background: #3498db;
            color: white;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .complete-btn {
            background: #27ae60;
            color: white;
        }

        .review-btn {
            background: #8e44ad;
            color: white;
        }

        .issue-btn {
            background: #e67e22;
            color: white;
        }

        .action-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner.show {
            display: block;
        }

        .user-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #2ecc71;
            color: white;
        }

        .status-inactive {
            background: #95a5a6;
            color: white;
        }

        .status-pending {
            background: #f39c12;
            color: white;
        }

        .status-completed {
            background: #2ecc71;
            color: white;
        }

        .status-review {
            background: #3498db;
            color: white;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .add-new-btn {
            padding: 10px 20px;
            background: linear-gradient(90deg, #1a2980, #26d0ce);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-new-btn:hover {
            background: linear-gradient(90deg, #152169, #1eafad);
            transform: translateY(-2px);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1a2980, #26d0ce);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .modal.show {
            display: flex;
        }

        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .save-btn {
            background: linear-gradient(90deg, #1a2980, #26d0ce);
            color: white;
        }

        .cancel-btn {
            background: #ecf0f1;
            color: #7f8c8d;
        }

        .modal-btn:hover {
            filter: brightness(1.1);
        }

        @media screen and (max-width: 1024px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media screen and (max-width: 768px) {
            .sidebar {
                width: 0;
                padding: 0;
                overflow: hidden;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 200;
                background: linear-gradient(90deg, #1a2980, #26d0ce);
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }
            
            .sidebar.show {
                width: 280px;
                padding: 20px;
            }
            
        }
        
        @media screen and (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="notification" class="notification">Data loaded successfully!</div>
    
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h2>Add New User</h2>
            <div class="form-group">
                <label for="userEmail">Email</label>
                <input type="email" id="userEmail" placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label for="userRole">Role</label>
                <select id="userRole">
                    <option value="admin">Admin</option>
                    <option value="manager">Manager</option>
                    <option value="team_member">Team Member</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn" onclick="closeModal('addUserModal')">Cancel</button>
                <button class="modal-btn save-btn" onclick="saveUser()">Save User</button>
            </div>
        </div>
    </div>
    
    <div id="addProjectModal" class="modal">
        <div class="modal-content">
            <h2>Add New Project</h2>
            <div class="form-group">
                <label for="projectName">Project Name</label>
                <input type="text" id="projectName" placeholder="New Project">
            </div>
            <div class="form-group">
                <label for="projectStatus">Status</label>
                <select id="projectStatus">
                    <option value="planning">Planning</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div class="form-group">
                <label for="projectDeadline">Deadline</label>
                <input type="date" id="projectDeadline">
            </div>
            <div class="form-group">
                <label for="projectLead">Team Lead</label>
                <select id="projectLead"></select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn" onclick="closeModal('addProjectModal')">Cancel</button>
                <button class="modal-btn save-btn" onclick="saveProject()">Save Project</button>
            </div>
        </div>
    </div>
    
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <h2>Add New Task</h2>
            <div class="form-group">
                <label for="taskTitle">Title</label>
                <input type="text" id="taskTitle" placeholder="Task title">
            </div>
            <div class="form-group">
                <label for="taskProject">Project</label>
                <select id="taskProject"></select>
            </div>
            <div class="form-group">
                <label for="taskPriority">Priority</label>
                <select id="taskPriority">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div class="form-group">
                <label for="taskDeadline">Deadline</label>
                <input type="date" id="taskDeadline">
            </div>
            <div class="form-group">
                <label for="taskAssignedTo">Assigned To</label>
                <select id="taskAssignedTo"></select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn" onclick="closeModal('addTaskModal')">Cancel</button>
                <button class="modal-btn save-btn" onclick="saveTask()">Save Task</button>
            </div>
        </div>
    </div>

    <div id="raiseIssueModal" class="modal">
        <div class="modal-content">
            <h2>Raise Issue</h2>
            <div class="form-group">
                <label for="issueTaskId">Task</label>
                <select id="issueTaskId"></select>
            </div>
            <div class="form-group">
                <label for="issueDescription">Description</label>
                <input type="text" id="issueDescription" placeholder="Describe the issue">
            </div>
            <div class="form-group">
                <label for="issueManagerId">Manager</label>
                <select id="issueManagerId"></select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn" onclick="closeModal('raiseIssueModal')">Cancel</button>
                <button class="modal-btn save-btn" onclick="saveIssue()">Submit Issue</button>
            </div>
        </div>
    </div>

    <div class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </div>

    <div class="container">
        <aside class="sidebar">
            <h2><i class="fas fa-cube"></i> ProManag</h2>
            <nav>
                <ul>
                    <li onclick="showSection('dashboard')" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
                    <li onclick="showSection('users')"><i class="fas fa-users"></i> User Management</li>
                    <li onclick="showSection('projects')"><i class="fas fa-project-diagram"></i> Projects</li>
                    <li onclick="showSection('tasks')"><i class="fas fa-tasks"></i> Tasks</li>
                    <li onclick="showSection('issues')"><i class="fas fa-exclamation-circle"></i> Issues</li>
                    <li onclick="showSection('messages')"><i class="fas fa-comments"></i> Messages</li>
                    <li onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</li>
                </ul>
            </nav>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </aside>

        <main class="main-content">
            <section id="dashboard" class="content-section active">
                <h1>Dashboard Overview</h1>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3><i class="fas fa-users"></i> Total Users</h3>
                        <p id="totalUsers">0</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-user-check"></i> Active Users</h3>
                        <p id="activeUsers">0</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-project-diagram"></i> Total Projects</h3>
                        <p id="totalProjects">0</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-tasks"></i> Total Tasks</h3>
                        <p id="totalTasks">0</p>
                    </div>
                </div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <h3>Project Status Distribution</h3>
                        <canvas id="projectStatusChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Task Completion Trend</h3>
                        <canvas id="taskCompletionChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card" style="margin-top: 25px;">
                    <h3>Recent Activities</h3>
                    <div id="recentActivities">
                        <div class="spinner" id="activitiesSpinner"></div>
                    </div>
                </div>
            </section>

            <section id="users" class="content-section">
                <div class="top-bar">
                    <h1>User Management</h1>
                    <button class="add-new-btn" onclick="openModal('addUserModal')">
                        <i class="fas fa-plus"></i> Add New User
                    </button>
                </div>
                <div class="search-bar">
                    <input type="text" id="userSearch" placeholder="Search users...">
                    <button onclick="searchUsers()"><i class="fas fa-search"></i> Search</button>
                </div>
                <div class="spinner" id="usersSpinner"></div>
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Updated At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </section>

            <section id="projects" class="content-section">
                <div class="top-bar">
                    <h1>Projects</h1>
                    <button class="add-new-btn" onclick="openModal('addProjectModal')">
                        <i class="fas fa-plus"></i> Add New Project
                    </button>
                </div>
                <div class="search-bar">
                    <input type="text" id="projectSearch" placeholder="Search projects...">
                    <button onclick="searchProjects()"><i class="fas fa-search"></i> Search</button>
                </div>
                <div class="spinner" id="projectsSpinner"></div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Progress</th>
                            <th>Deadline</th>
                            <th>Team Lead</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="projectsTable"></tbody>
                </table>
            </section>

            <section id="tasks" class="content-section">
                <div class="top-bar">
                    <h1>Tasks</h1>
                    <button class="add-new-btn" onclick="openModal('addTaskModal')">
                        <i class="fas fa-plus"></i> Add New Task
                    </button>
                </div>
                <div class="search-bar">
                    <input type="text" id="taskSearch" placeholder="Search tasks...">
                    <button onclick="searchTasks()"><i class="fas fa-search"></i> Search</button>
                </div>
                <div class="spinner" id="tasksSpinner"></div>
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Project</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Deadline</th>
                            <th>Progress</th>
                            <th>Assigned To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTable"></tbody>
                </table>
            </section>

            <section id="issues" class="content-section">
                <div class="top-bar">
                    <h1>Issues</h1>
                    <button class="add-new-btn" onclick="openModal('raiseIssueModal')">
                        <i class="fas fa-plus"></i> Raise New Issue
                    </button>
                </div>
                <div class="search-bar">
                    <input type="text" id="issueSearch" placeholder="Search issues...">
                    <button onclick="searchIssues()"><i class="fas fa-search"></i> Search</button>
                </div>
                <div class="spinner" id="issuesSpinner"></div>
                <table>
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th>Description</th>
                            <th>Raised By</th>
                            <th>Manager</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="issuesTable"></tbody>
                </table>
            </section>

            <section id="messages" class="content-section">
                <h1>Messages</h1>
                <div class="search-bar">
                    <input type="text" id="messageSearch" placeholder="Search messages...">
                    <button onclick="searchMessages()"><i class="fas fa-search"></i> Search</button>
                </div>
                <div class="spinner" id="messagesSpinner"></div>
                <table>
                    <thead>
                        <tr>
                            <th>Text</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Timestamp</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="messagesTable"></tbody>
                </table>
            </section>
            
            <section id="settings" class="content-section">
                <h1>Settings</h1>
                <div class="form-group">
                    <label for="darkMode">Dark Mode</label>
                    <input type="checkbox" id="darkMode">
                </div>
                <div class="form-group">
                    <label for="notifications">Enable Notifications</label>
                    <input type="checkbox" id="notifications" checked>
                </div>
                <div class="form-group">
                    <label for="language">Language</label>
                    <select id="language">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
                <button class="add-new-btn" style="margin-top: 20px;" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </section>
        </main>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDmVWaGD-XXrDpH4NN8C31pyps24jirAJU",
            authDomain: "promanag-6b374.firebaseapp.com",
            projectId: "promanag-6b374",
            storageBucket: "promanag-6b374.appspot.com",
            messagingSenderId: "294380471934",
            appId: "1:294380471934:web:ce389b0b1be289e5a0ba2f",
            measurementId: "G-MJV4M2KZDW"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global variables
        let usersData = [];
        let projectsData = [];
        let tasksData = [];
        let messagesData = [];
        let activitiesData = [];
        let issuesData = [];


        async function logout() {
            try {
                if (confirm('Are you sure you want to logout?')) {
                    await auth.signOut();
                    showNotification('Logged out successfully!');
                    // Redirect to login page after a short delay
                    setTimeout(() => {
                        window.location.href = '/login.html'; // Adjust the path as needed
                    }, 1000);
                }
            } catch (error) {
                console.error('Error during logout:', error);
                showNotification('Error during logout', 'error');
            }
        }

        // Check authentication state
        auth.onAuthStateChanged((user) => {
            if (!user) {
                // If no user is signed in, redirect to login page
                window.location.href = '/'; // Adjust the path as needed
            } else {
                // User is signed in, load the dashboard
                loadDashboardData();
            }
        });
        // Utility functions
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            const menuItems = document.querySelectorAll('.sidebar li');
            menuItems.forEach(item => item.classList.remove('active'));
            const clickedItem = Array.from(menuItems).find(item => 
                item.textContent.toLowerCase().includes(sectionId.toLowerCase())
            );
            if (clickedItem) clickedItem.classList.add('active');
            
            loadSectionData(sectionId);
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('show');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'error' ? 
                'linear-gradient(90deg, #e74c3c, #c0392b)' : 
                'linear-gradient(90deg, #1a2980, #26d0ce)';
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        function formatDate(timestamp) {
            const date = timestamp instanceof firebase.firestore.Timestamp ? 
                timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('show');
            if (modalId === 'addProjectModal') populateProjectLeadDropdown();
            if (modalId === 'addTaskModal') populateTaskDropdowns();
            if (modalId === 'raiseIssueModal') populateIssueDropdowns();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showSpinner(id, show = true) {
            document.getElementById(id).classList[show ? 'add' : 'remove']('show');
        }

        // Data loading functions
        async function loadSectionData(section) {
            switch(section) {
                case 'dashboard': loadDashboardData(); break;
                case 'users': loadUsers(); break;
                case 'projects': loadProjects(); break;
                case 'tasks': loadTasks(); break;
                case 'issues': loadIssues(); break;
                case 'messages': loadMessages(); break;
                case 'settings': loadSettings(); break;
            }
        }

        async function loadDashboardData() {
            try {
                showSpinner('activitiesSpinner', true);
                
                const [usersSnap, projectsSnap, tasksSnap, messagesSnap, issuesSnap] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('projects').get(),
                    db.collection('tasks').get(),
                    db.collection('messages').get(),
                    db.collection('issues').get()
                ]);

                usersData = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                projectsData = projectsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                tasksData = tasksSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                messagesData = messagesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                issuesData = issuesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                document.getElementById('totalUsers').textContent = usersData.length;
                document.getElementById('activeUsers').textContent = usersData.filter(u => 
                    u.status === 'active' || !u.status).length;
                document.getElementById('totalProjects').textContent = projectsData.length;
                document.getElementById('totalTasks').textContent = tasksData.length;

                createProjectStatusChart();
                createTaskCompletionChart();
                await loadRecentActivities();

                showNotification('Dashboard data loaded successfully!');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showNotification('Error loading dashboard data', 'error');
            } finally {
                showSpinner('activitiesSpinner', false);
            }
        }

        async function loadRecentActivities() {
            try {
                const activitiesSnap = await db.collection('tasks')
                    .orderBy('updatedAt', 'desc')
                    .limit(5)
                    .get();
                
                activitiesData = activitiesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const activitiesContainer = document.getElementById('recentActivities');
                let html = '<ul style="list-style: none; padding: 0;">';
                
                activitiesData.forEach(activity => {
                    html += `
                        <li style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                            <div>
                                <strong>${activity.createdBy || 'User'}</strong> updated task <em>${activity.title}</em>
                            </div>
                            <div style="color: #7f8c8d;">${formatDate(activity.updatedAt)}</div>
                        </li>
                    `;
                });
                
                html += '</ul>';
                activitiesContainer.innerHTML = html;
            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        async function loadUsers() {
            try {
                showSpinner('usersSpinner', true);
                const usersTable = document.getElementById('usersTable');
                let html = '';
                
                if (!usersData.length) {
                    const usersSnap = await db.collection('users').get();
                    usersData = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                usersData.forEach(user => {
                    const status = user.status || 'active';
                    html += `
                        <tr>
                            <td>${user.email}</td>
                            <td>${user.role.replace('_', ' ')}</td>
                            <td>
                                <span class="user-status ${status === 'active' ? 'status-active' : 'status-inactive'}">
                                    ${status}
                                </span>
                            </td>
                            <td>${formatDate(user.createdAt)}</td>
                            <td>${formatDate(user.updatedAt)}</td>
                            <td class="action-buttons">
                                <button class="action-btn edit-btn" onclick="editUser('${user.id}')"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete-btn" onclick="deleteUser('${user.id}')"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                usersTable.innerHTML = html;
                showNotification('Users loaded successfully!');
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Error loading users', 'error');
            } finally {
                showSpinner('usersSpinner', false);
            }
        }

        async function loadProjects() {
            try {
                showSpinner('projectsSpinner', true);
                const projectsTable = document.getElementById('projectsTable');
                let html = '';
                
                if (!projectsData.length) {
                    const projectsSnap = await db.collection('projects').get();
                    projectsData = projectsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                projectsData.forEach(project => {
                    const teamLead = usersData.find(u => u.id === project.teamLead)?.email || 'Unassigned';
                    html += `
                        <tr>
                            <td>${project.name}</td>
                            <td>${project.status.replace('_', ' ')}</td>
                            <td>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                                </div>
                                <div style="text-align: right; font-size: 12px; margin-top: 5px;">${project.progress || 0}%</div>
                            </td>
                            <td>${project.deadline}</td>
                            <td>${teamLead}</td>
                            <td class="action-buttons">
                                <button class="action-btn edit-btn" onclick="editProject('${project.id}')"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete-btn" onclick="deleteProject('${project.id}')"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                projectsTable.innerHTML = html;
                showNotification('Projects loaded successfully!');
            } catch (error) {
                console.error('Error loading projects:', error);
                showNotification('Error loading projects', 'error');
            } finally {
                showSpinner('projectsSpinner', false);
            }
        }

        async function loadTasks() {
            try {
                showSpinner('tasksSpinner', true);
                const tasksTable = document.getElementById('tasksTable');
                let html = '';
                
                if (!tasksData.length) {
                    const tasksSnap = await db.collection('tasks').get();
                    tasksData = tasksSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                for (const task of tasksData) {
                    const project = projectsData.find(p => p.id === task.projectId) || { name: 'Unknown' };
                    const assignedUser = usersData.find(u => u.id === task.assignedTo) || { email: 'Unassigned' };
                    const statusClass = task.status === 'completed' ? 'status-completed' :
                        task.status === 'review' ? 'status-review' : 'status-pending';
                    
                    html += `
                        <tr>
                            <td>${task.title}</td>
                            <td>${project.name}</td>
                            <td>
                                <span class="user-status ${statusClass}">${task.status.replace('_', ' ')}</span>
                            </td>
                            <td>${task.priority}</td>
                            <td>${task.deadline}</td>
                            <td>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${task.progress || 0}%"></div>
                                </div>
                                <div style="text-align: right; font-size: 12px; margin-top: 5px;">${task.progress || 0}%</div>
                            </td>
                            <td>${assignedUser.email}</td>
                            <td class="action-buttons">
                                <button class="action-btn edit-btn" onclick="editTask('${task.id}')"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete-btn" onclick="deleteTask('${task.id}')"><i class="fas fa-trash-alt"></i></button>
                                ${task.status !== 'completed' && task.status !== 'review' ? 
                                    `<button class="action-btn complete-btn" onclick="completeTask('${task.id}')">Complete</button>` : ''}
                                ${task.status === 'completed' ? 
                                    `<button class="action-btn review-btn" onclick="reviewTask('${task.id}')">Review</button>` : ''}
                                <button class="action-btn issue-btn" onclick="raiseIssueForTask('${task.id}')">Issue</button>
                            </td>
                        </tr>
                    `;
                }
                
                tasksTable.innerHTML = html;
                showNotification('Tasks loaded successfully!');
            } catch (error) {
                console.error('Error loading tasks:', error);
                showNotification('Error loading tasks', 'error');
            } finally {
                showSpinner('tasksSpinner', false);
            }
        }

        async function loadIssues() {
            try {
                showSpinner('issuesSpinner', true);
                const issuesTable = document.getElementById('issuesTable');
                let html = '';
                
                if (!issuesData.length) {
                    const issuesSnap = await db.collection('issues').get();
                    issuesData = issuesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                for (const issue of issuesData) {
                    const task = tasksData.find(t => t.id === issue.taskId) || { title: 'Unknown' };
                    const raisedBy = usersData.find(u => u.id === issue.userId) || { email: 'Unknown' };
                    const manager = usersData.find(u => u.id === issue.managerId) || { email: 'Unknown' };
                    
                    html += `
                        <tr>
                            <td>${task.title}</td>
                            <td>${issue.description}</td>
                            <td>${raisedBy.email}</td>
                            <td>${manager.email}</td>
                            <td>${issue.status}</td>
                            <td>${formatDate(issue.createdAt)}</td>
                            <td class="action-buttons">
                                <button class="action-btn edit-btn" onclick="editIssue('${issue.id}')"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete-btn" onclick="deleteIssue('${issue.id}')"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                }
                
                issuesTable.innerHTML = html;
                showNotification('Issues loaded successfully!');
            } catch (error) {
                console.error('Error loading issues:', error);
                showNotification('Error loading issues', 'error');
            } finally {
                showSpinner('issuesSpinner', false);
            }
        }

        async function loadMessages() {
            try {
                showSpinner('messagesSpinner', true);
                const messagesTable = document.getElementById('messagesTable');
                let html = '';
                
                if (!messagesData.length) {
                    const messagesSnap = await db.collection('messages').get();
                    messagesData = messagesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                messagesData.forEach(message => {
                    html += `
                        <tr>
                            <td>${message.text}</td>
                            <td>${message.userId || 'Unknown'}</td>
                            <td>${message.to || 'all'}</td>
                            <td>${formatDate(message.timestamp)}</td>
                            <td class="action-buttons">
                                <button class="action-btn edit-btn" onclick="replyMessage('${message.id}')"><i class="fas fa-reply"></i></button>
                                <button class="action-btn delete-btn" onclick="deleteMessage('${message.id}')"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                messagesTable.innerHTML = html;
                showNotification('Messages loaded successfully!');
            } catch (error) {
                console.error('Error loading messages:', error);
                showNotification('Error loading messages', 'error');
            } finally {
                showSpinner('messagesSpinner', false);
            }
        }

        function loadSettings() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            const notifications = localStorage.getItem('notifications') !== 'false';
            const language = localStorage.getItem('language') || 'en';
            
            document.getElementById('darkMode').checked = darkMode;
            document.getElementById('notifications').checked = notifications;
            document.getElementById('language').value = language;
        }

        // CRUD Operations
        async function saveUser() {
            try {
                const email = document.getElementById('userEmail').value;
                const role = document.getElementById('userRole').value;
                
                if (!email) {
                    showNotification('Email is required', 'error');
                    return;
                }
                
                const newUser = {
                    email,
                    role,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('users').add(newUser);
                usersData.push({ id: docRef.id, ...newUser });
                
                loadUsers();
                document.getElementById('totalUsers').textContent = usersData.length;
                document.getElementById('activeUsers').textContent = usersData.filter(u => 
                    u.status === 'active').length;
                
                closeModal('addUserModal');
                showNotification('User added successfully!');
                
                document.getElementById('userEmail').value = '';
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification('Error adding user', 'error');
            }
        }

        async function saveProject() {
            try {
                const name = document.getElementById('projectName').value;
                const status = document.getElementById('projectStatus').value;
                const deadline = document.getElementById('projectDeadline').value;
                const teamLead = document.getElementById('projectLead').value;
                
                if (!name || !deadline) {
                    showNotification('Project name and deadline are required', 'error');
                    return;
                }
                
                const newProject = {
                    name,
                    status,
                    deadline,
                    teamLead,
                    progress: status === 'completed' ? 100 : status === 'planning' ? 10 : 25,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('projects').add(newProject);
                projectsData.push({ id: docRef.id, ...newProject });
                
                loadProjects();
                document.getElementById('totalProjects').textContent = projectsData.length;
                createProjectStatusChart();
                
                closeModal('addProjectModal');
                showNotification('Project added successfully!');
                
                document.getElementById('projectName').value = '';
                document.getElementById('projectDeadline').value = '';
            } catch (error) {
                console.error('Error adding project:', error);
                showNotification('Error adding project', 'error');
            }
        }

        async function saveTask() {
            try {
                const title = document.getElementById('taskTitle').value;
                const projectId = document.getElementById('taskProject').value;
                const priority = document.getElementById('taskPriority').value;
                const deadline = document.getElementById('taskDeadline').value;
                const assignedTo = document.getElementById('taskAssignedTo').value;

                if (!title || !projectId || !deadline) {
                    showNotification('Title, project, and deadline are required', 'error');
                    return;
                }

                const newTask = {
                    title,
                    projectId,
                    status: 'pending',
                    priority,
                    deadline,
                    assignedTo,
                    progress: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const docRef = await db.collection('tasks').add(newTask);
                tasksData.push({ id: docRef.id, ...newTask });

                loadTasks();
                document.getElementById('totalTasks').textContent = tasksData.length;
                createTaskCompletionChart();

                closeModal('addTaskModal');
                showNotification('Task added successfully!');

                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDeadline').value = '';
            } catch (error) {
                console.error('Error adding task:', error);
                showNotification('Error adding task', 'error');
            }
        }

        async function saveIssue() {
            try {
                const taskId = document.getElementById('issueTaskId').value;
                const description = document.getElementById('issueDescription').value;
                const managerId = document.getElementById('issueManagerId').value;
                const userId = tasksData.find(t => t.id === taskId)?.assignedTo;

                if (!description) {
                    showNotification('Description is required', 'error');
                    return;
                }

                const newIssue = {
                    taskId,
                    description,
                    userId,
                    managerId,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const docRef = await db.collection('issues').add(newIssue);
                issuesData.push({ id: docRef.id, ...newIssue });

                loadIssues();
                closeModal('raiseIssueModal');
                showNotification('Issue raised successfully!');
                
                document.getElementById('issueDescription').value = '';
            } catch (error) {
                console.error('Error raising issue:', error);
                showNotification('Error raising issue', 'error');
            }
        }

        async function completeTask(taskId) {
            try {
                const task = tasksData.find(t => t.id === taskId);
                if (!task) return;

                await db.collection('tasks').doc(taskId).update({
                    status: 'completed',
                    progress: 100,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const index = tasksData.findIndex(t => t.id === taskId);
                tasksData[index].status = 'completed';
                tasksData[index].progress = 100;

                loadTasks();
                createTaskCompletionChart();
                showNotification('Task marked as completed!');
            } catch (error) {
                console.error('Error completing task:', error);
                showNotification('Error completing task', 'error');
            }
        }

        async function reviewTask(taskId) {
            try {
                const task = tasksData.find(t => t.id === taskId);
                if (!task) return;

                await db.collection('tasks').doc(taskId).update({
                    status: 'review',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const index = tasksData.findIndex(t => t.id === taskId);
                tasksData[index].status = 'review';

                loadTasks();
                showNotification('Task marked for review!');
            } catch (error) {
                console.error('Error reviewing task:', error);
                showNotification('Error reviewing task', 'error');
            }
        }

        function raiseIssueForTask(taskId) {
            document.getElementById('issueTaskId').value = taskId;
            populateIssueDropdowns(taskId);
            openModal('raiseIssueModal');
        }

        // Delete functions
        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    await db.collection('users').doc(userId).delete();
                    usersData = usersData.filter(u => u.id !== userId);
                    loadUsers();
                    showNotification('User deleted successfully!');
                } catch (error) {
                    console.error('Error deleting user:', error);
                    showNotification('Error deleting user', 'error');
                }
            }
        }

        async function deleteProject(projectId) {
            if (confirm('Are you sure you want to delete this project?')) {
                try {
                    await db.collection('projects').doc(projectId).delete();
                    projectsData = projectsData.filter(p => p.id !== projectId);
                    loadProjects();
                    showNotification('Project deleted successfully!');
                } catch (error) {
                    console.error('Error deleting project:', error);
                    showNotification('Error deleting project', 'error');
                }
            }
        }

        async function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                try {
                    await db.collection('tasks').doc(taskId).delete();
                    tasksData = tasksData.filter(t => t.id !== taskId);
                    loadTasks();
                    showNotification('Task deleted successfully!');
                } catch (error) {
                    console.error('Error deleting task:', error);
                    showNotification('Error deleting task', 'error');
                }
            }
        }

        async function deleteIssue(issueId) {
            if (confirm('Are you sure you want to delete this issue?')) {
                try {
                    await db.collection('issues').doc(issueId).delete();
                    issuesData = issuesData.filter(i => i.id !== issueId);
                    loadIssues();
                    showNotification('Issue deleted successfully!');
                } catch (error) {
                    console.error('Error deleting issue:', error);
                    showNotification('Error deleting issue', 'error');
                }
            }
        }

        async function deleteMessage(messageId) {
            if (confirm('Are you sure you want to delete this message?')) {
                try {
                    await db.collection('messages').doc(messageId).delete();
                    messagesData = messagesData.filter(m => m.id !== messageId);
                    loadMessages();
                    showNotification('Message deleted successfully!');
                } catch (error) {
                    console.error('Error deleting message:', error);
                    showNotification('Error deleting message', 'error');
                }
            }
        }

        // Edit functions (placeholder - implement as needed)
        function editUser(userId) {
            console.log('Edit user:', userId);
            // Add edit modal implementation here
        }

        function editProject(projectId) {
            console.log('Edit project:', projectId);
            // Add edit modal implementation here
        }

        function editTask(taskId) {
            console.log('Edit task:', taskId);
            // Add edit modal implementation here
        }

        function editIssue(issueId) {
            console.log('Edit issue:', issueId);
            // Add edit modal implementation here
        }

        function replyMessage(messageId) {
            console.log('Reply to message:', messageId);
            // Add reply implementation here
        }

        // Chart creation
        function createProjectStatusChart() {
            const ctx = document.getElementById('projectStatusChart').getContext('2d');
            const statuses = ['planning', 'in_progress', 'completed'];
            const counts = statuses.map(status => 
                projectsData.filter(p => p.status === status).length
            );
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Planning', 'In Progress', 'Completed'],
                    datasets: [{
                        data: counts,
                        backgroundColor: ['#3498db', '#f39c12', '#2ecc71'],
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function createTaskCompletionChart() {
            const ctx = document.getElementById('taskCompletionChart').getContext('2d');
            const completed = tasksData.filter(t => t.status === 'completed').length;
            const total = tasksData.length;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Current'],
                    datasets: [
                        {
                            label: 'Completed Tasks',
                            data: [completed],
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.2)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Total Tasks',
                            data: [total],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // Dropdown population
        async function populateProjectLeadDropdown() {
            const dropdown = document.getElementById('projectLead');
            dropdown.innerHTML = '';
            
            if (!usersData.length) {
                const usersSnap = await db.collection('users').get();
                usersData = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
            
            const eligibleUsers = usersData.filter(user => 
                user.role === 'manager' || user.role === 'admin'
            );
            
            eligibleUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.email;
                dropdown.appendChild(option);
            });
        }

        async function populateTaskDropdowns() {
            const projectDropdown = document.getElementById('taskProject');
            const assignedToDropdown = document.getElementById('taskAssignedTo');

            if (!projectsData.length) {
                const projectsSnap = await db.collection('projects').get();
                projectsData = projectsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            if (!usersData.length) {
                const usersSnap = await db.collection('users').get();
                usersData = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            projectDropdown.innerHTML = projectsData.map(project => 
                `<option value="${project.id}">${project.name}</option>`
            ).join('');

            const teamMembers = usersData.filter(u => u.role === 'team_member' || u.role === 'manager');
            assignedToDropdown.innerHTML = teamMembers.map(user => 
                `<option value="${user.id}">${user.email}</option>`
            ).join('');
        }

        async function populateIssueDropdowns(selectedTaskId = '') {
            const taskDropdown = document.getElementById('issueTaskId');
            const managerDropdown = document.getElementById('issueManagerId');
            
            if (!tasksData.length) {
                const tasksSnap = await db.collection('tasks').get();
                tasksData = tasksSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            if (!usersData.length) {
                const usersSnap = await db.collection('users').get();
                usersData = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            taskDropdown.innerHTML = tasksData.map(task => 
                `<option value="${task.id}" ${task.id === selectedTaskId ? 'selected' : ''}>${task.title}</option>`
            ).join('');

            const managers = usersData.filter(u => u.role === 'manager' || u.role === 'admin');
            managerDropdown.innerHTML = managers.map(manager => 
                `<option value="${manager.id}">${manager.email}</option>`
            ).join('');
        }

        // Search functions
        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            if (!searchTerm) {
                loadUsers();
                return;
            }
            
            const filteredUsers = usersData.filter(user => 
                user.email.toLowerCase().includes(searchTerm) || 
                user.role.toLowerCase().includes(searchTerm)
            );
            
            const usersTable = document.getElementById('usersTable');
            let html = '';
            
            filteredUsers.forEach(user => {
                const status = user.status || 'active';
                html += `
                    <tr>
                        <td>${user.email}</td>
                        <td>${user.role.replace('_', ' ')}</td>
                        <td>
                            <span class="user-status ${status === 'active' ? 'status-active' : 'status-inactive'}">
                                ${status}
                            </span>
                        </td>
                        <td>${formatDate(user.createdAt)}</td>
                        <td>${formatDate(user.updatedAt)}</td>
                        <td class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editUser('${user.id}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" onclick="deleteUser('${user.id}')"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            usersTable.innerHTML = html;
        }

        function searchProjects() {
            const searchTerm = document.getElementById('projectSearch').value.toLowerCase();
            if (!searchTerm) {
                loadProjects();
                return;
            }
            
            const filteredProjects = projectsData.filter(project => 
                project.name.toLowerCase().includes(searchTerm) || 
                project.status.toLowerCase().includes(searchTerm) ||
                (usersData.find(u => u.id === project.teamLead)?.email || '').toLowerCase().includes(searchTerm)
            );
            
            const projectsTable = document.getElementById('projectsTable');
            let html = '';
            
            filteredProjects.forEach(project => {
                const teamLead = usersData.find(u => u.id === project.teamLead)?.email || 'Unassigned';
                html += `
                    <tr>
                        <td>${project.name}</td>
                        <td>${project.status.replace('_', ' ')}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                            </div>
                            <div style="text-align: right; font-size: 12px; margin-top: 5px;">${project.progress || 0}%</div>
                        </td>
                        <td>${project.deadline}</td>
                        <td>${teamLead}</td>
                        <td class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editProject('${project.id}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" onclick="deleteProject('${project.id}')"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            projectsTable.innerHTML = html;
        }

        function searchTasks() {
            const searchTerm = document.getElementById('taskSearch').value.toLowerCase();
            if (!searchTerm) {
                loadTasks();
                return;
            }
            
            const filteredTasks = tasksData.filter(task => 
                task.title.toLowerCase().includes(searchTerm) || 
                (projectsData.find(p => p.id === task.projectId)?.name || '').toLowerCase().includes(searchTerm) ||
                task.status.toLowerCase().includes(searchTerm) ||
                task.priority.toLowerCase().includes(searchTerm) ||
                (usersData.find(u => u.id === task.assignedTo)?.email || '').toLowerCase().includes(searchTerm)
            );
            
            const tasksTable = document.getElementById('tasksTable');
            let html = '';
            
            filteredTasks.forEach(task => {
                const project = projectsData.find(p => p.id === task.projectId) || { name: 'Unknown' };
                const assignedUser = usersData.find(u => u.id === task.assignedTo) || { email: 'Unassigned' };
                const statusClass = task.status === 'completed' ? 'status-completed' :
                    task.status === 'review' ? 'status-review' : 'status-pending';
                
                html += `
                    <tr>
                        <td>${task.title}</td>
                        <td>${project.name}</td>
                        <td>
                            <span class="user-status ${statusClass}">${task.status.replace('_', ' ')}</span>
                        </td>
                        <td>${task.priority}</td>
                        <td>${task.deadline}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${task.progress || 0}%"></div>
                            </div>
                            <div style="text-align: right; font-size: 12px; margin-top: 5px;">${task.progress || 0}%</div>
                        </td>
                        <td>${assignedUser.email}</td>
                        <td class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editTask('${task.id}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" onclick="deleteTask('${task.id}')"><i class="fas fa-trash-alt"></i></button>
                            ${task.status !== 'completed' && task.status !== 'review' ? 
                                `<button class="action-btn complete-btn" onclick="completeTask('${task.id}')">Complete</button>` : ''}
                            ${task.status === 'completed' ? 
                                `<button class="action-btn review-btn" onclick="reviewTask('${task.id}')">Review</button>` : ''}
                            <button class="action-btn issue-btn" onclick="raiseIssueForTask('${task.id}')">Issue</button>
                        </td>
                    </tr>
                `;
            });
            
            tasksTable.innerHTML = html;
        }

        function searchIssues() {
            const searchTerm = document.getElementById('issueSearch').value.toLowerCase();
            if (!searchTerm) {
                loadIssues();
                return;
            }
            
            const filteredIssues = issuesData.filter(issue => 
                (tasksData.find(t => t.id === issue.taskId)?.title || '').toLowerCase().includes(searchTerm) ||
                issue.description.toLowerCase().includes(searchTerm) ||
                (usersData.find(u => u.id === issue.userId)?.email || '').toLowerCase().includes(searchTerm) ||
                (usersData.find(u => u.id === issue.managerId)?.email || '').toLowerCase().includes(searchTerm)
            );
            
            const issuesTable = document.getElementById('issuesTable');
            let html = '';
            
            filteredIssues.forEach(issue => {
                const task = tasksData.find(t => t.id === issue.taskId) || { title: 'Unknown' };
                const raisedBy = usersData.find(u => u.id === issue.userId) || { email: 'Unknown' };
                const manager = usersData.find(u => u.id === issue.managerId) || { email: 'Unknown' };
                
                html += `
                    <tr>
                        <td>${task.title}</td>
                        <td>${issue.description}</td>
                        <td>${raisedBy.email}</td>
                        <td>${manager.email}</td>
                        <td>${issue.status}</td>
                        <td>${formatDate(issue.createdAt)}</td>
                        <td class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editIssue('${issue.id}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" onclick="deleteIssue('${issue.id}')"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            issuesTable.innerHTML = html;
        }

        function searchMessages() {
            const searchTerm = document.getElementById('messageSearch').value.toLowerCase();
            if (!searchTerm) {
                loadMessages();
                return;
            }
            
            const filteredMessages = messagesData.filter(message => 
                message.text.toLowerCase().includes(searchTerm) || 
                (message.userId || '').toLowerCase().includes(searchTerm) ||
                (message.to || '').toLowerCase().includes(searchTerm)
            );
            
            const messagesTable = document.getElementById('messagesTable');
            let html = '';
            
            filteredMessages.forEach(message => {
                html += `
                    <tr>
                        <td>${message.text}</td>
                        <td>${message.userId || 'Unknown'}</td>
                        <td>${message.to || 'all'}</td>
                        <td>${formatDate(message.timestamp)}</td>
                        <td class="action-buttons">
                            <button class="action-btn edit-btn" onclick="replyMessage('${message.id}')"><i class="fas fa-reply"></i></button>
                            <button class="action-btn delete-btn" onclick="deleteMessage('${message.id}')"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            messagesTable.innerHTML = html;
        }

        // Settings
        function saveSettings() {
            localStorage.setItem('darkMode', document.getElementById('darkMode').checked);
            localStorage.setItem('notifications', document.getElementById('notifications').checked);
            localStorage.setItem('language', document.getElementById('language').value);
            showNotification('Settings saved successfully!');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            
            document.getElementById('darkMode').addEventListener('change', function(e) {
                localStorage.setItem('darkMode', e.target.checked);
            });
            
            document.getElementById('notifications').addEventListener('change', function(e) {
                localStorage.setItem('notifications', e.target.checked);
            });
            
            document.getElementById('language').addEventListener('change', function(e) {
                localStorage.setItem('language', e.target.value);
            });
            
        });
        
    </script>
</body>
</html>